;***********************************************************************************************************************************
; Biblioteca para controle de LCD via PIC - MFR_LCD.INC
; Data da Criação: 08/06/2006   -   Autor: Engº Mauricio Fernandes Raphael
;***********************************************************************************************************************************
INCLUDE <P16F877A.INC>

;***********************************************************************************************************************************
; O CÓDIGO ABAIXO DEVERÁ SER COLOCADO NA SEÇÃO DE DEFINES DO ARQUIVO QUE CHAMA ESTE INCLUDE
;
;; ********** DEFINES PARA LCD **********
;#DEFINE		LCD_PORTA8BITS	PORTA
;#DEFINE		LCD_PINO_E		PORTA
;#DEFINE		LCD_PINO_RS		PORTA
;#DEFINE		LCD_PINO_RW		PORTA
;#DEFINE		LCD_PINO_B0		PORTA
;#DEFINE		LCD_PINO_B1		PORTA
;#DEFINE		LCD_PINO_B2		PORTA
;#DEFINE		LCD_PINO_B3		PORTA
;#DEFINE		LCD_PINO_B4		PORTA
;#DEFINE		LCD_PINO_B5		PORTA
;#DEFINE		LCD_PINO_B6		PORTA
;#DEFINE		LCD_PINO_B7		PORTA
;
; ESCREVER NO CBBLOCK A VARIAVEL:  LCD_BITS_PORTA , sendo .4 = 4bits e .8 = 8bits , escrever tb o LCD_VAR_TEMP
; se tiver operação de leitura do LCD, é necessário criar a variável LCD_LEITURA_PORTA
;***********************************************************************************************************************************

; ********** DEFINES PARA LCD **********
#DEFINE		LCD_VALOR_LIMPA_LCD		B'00000001'
#DEFINE		LCD_CURSOR_HOME			B'00000011'
#DEFINE		LCD_MODO_OPERACAO		B'00000100'
#DEFINE		LCD_MODO_DISPLAY_CURSOR	B'00001000'
#DEFINE		LCD_DESLOC_CURSOR_MSG	B'00010000'

; ********** MACROS PARA LCD **********
MACRO_LCD_PULSO_ENABLE MACRO
	BANKSEL LCD_PINO_E	
	BSF		LCD_PINO_E
	NOP
	BCF		LCD_PINO_E
ENDM

MACRO_LCD_PINO_E MACRO ESTADO
	BANKSEL LCD_PINO_E
	IF ESTADO == TRUE
		BSF		LCD_PINO_E
	ELSE IF ESTADO == FALSE
		BCF		LCD_PINO_E
	ENDIF
ENDM

MACRO_LCD_PINO_RS MACRO ESTADO
	BANKSEL LCD_PINO_RS
	IF ESTADO == TRUE
		BSF		LCD_PINO_RS
	ELSE IF ESTADO == FALSE
		BCF		LCD_PINO_RS
	ENDIF
ENDM

MACRO_LCD_PINO_RW MACRO ESTADO
	BANKSEL LCD_PINO_RW
	IF ESTADO == TRUE
		BSF		LCD_PINO_RW
	ELSE IF ESTADO == FALSE
		BCF		LCD_PINO_RW
	ENDIF
ENDM

MACRO_LCD_PORTA_COMUNICACAO_8BITS MACRO DADO , TIPO , UNIDADE_TEMPO , VALOR_TEMPO
	MACRO_LCD_PINO_E FALSE
	MOVLW		DADO
	IF TIPO == 'E' ; escreve dado na porta do LCD
		MACRO_LCD_PINO_RS TRUE
		MACRO_LCD_PINO_RW FALSE
		MOVWF		LCD_PORTA8BITS
		MACRO_LCD_PULSO_ENABLE
	ELSE IF TIPO == 'L' ; le dado na porta do LCD
		MACRO_LCD_PINO_RS TRUE
		MACRO_LCD_PINO_RW TRUE
		MOVF		LCD_PORTA8BITS , LCD_LEITURA_PORTA ;escreve dados lidos na varivavel leitura porta
	ELSE IF TIPO == 'C' ; escreve comando na porta do LCD
		MACRO_LCD_PINO_RS FALSE
		MACRO_LCD_PINO_RW FALSE
		MOVWF		LCD_PORTA8BITS
		MACRO_LCD_PULSO_ENABLE
	ENDIF
	;depois de dar o enable é necessário um determinado tempo conforme a ação executada por necessidade do próprio LCD
	IF UNIDADE_TEMPO == 'U' ;unidade em microsegundos
																	; ******** FALTA ESCREVER MACRO DE TEMPO Q EU AINDA Ñ FIZ ******
	ELSE IF UNIDADE_TEMPO == 'M' ;unidade em milisegundos
	
	ENDIF
ENDM

MACRO_LCD_LIMPA_DISPLAY MACRO
	IF LCD_BITS_PORTA == .4 ;4 bits
	
	ELSE IF LCD_BITS_PORTA == .8 ;8 bits
		MACRO_LCD_PORTA_COMUNICACAO_8BITS LCD_VALOR_LIMPA_LCD , 'C' , 'M' , .2
	ENDIF
ENDM

MACRO_LCD_CURSOR_HOME MACRO
	IF LCD_BITS_PORTA == .4 ;4 bits
	
	ELSE IF LCD_BITS_PORTA == .8 ;8 bits
		MACRO_LCD_PORTA_COMUNICACAO_8BITS LCD_CURSOR_HOME , 'C' , 'M' , .2
	ENDIF
ENDM

MACRO_LCD_MODO_OPERACAO MACRO DESLOCAMENTO_MSG , CURSOR PARA DIREITA ;entry mode set
	MOVLW		LCD_MODO_OPERACAO
	MOVWF		LCD_VAR_TEMP	
	IF DESLOCAMENTO_MSG == 1
		BSF		LCD_VAR_TEMP , 0
	ELSE IF DESLOCAMENTO_MSG == 0
		BCF		LCD_VAR_TEMP , 0
	ENDIF
	IF CURSOR PARA DIREITA == 1
		BSF		LCD_VAR_TEMP , 1
	ELSE IF CURSOR PARA DIREITA == 0
		BCF		LCD_VAR_TEMP , 1
	ENDIF
	IF LCD_BITS_PORTA == .4 ;4 bits
	
	ELSE IF LCD_BITS_PORTA == .8 ;8 bits
		MACRO_LCD_PORTA_COMUNICACAO_8BITS LCD_VAR_TEMP , 'C' , 'U' , .50
	ENDIF
ENDM

MACRO_LCD_MODO_DISPLAY_CURSOR MACRO CURSOR_PISCANTE , CURSOR_VISIVEL_LINHA , LIGA_DISPLAY ;display/control ON/OFF
	MOVLW		LCD_MODO_DISPLAY_CURSOR
	MOVWF		LCD_VAR_TEMP	
	IF CURSOR_PISCANTE == 1
		BSF		LCD_VAR_TEMP , 0
	ELSE IF CURSOR_PISCANTE == 0
		BCF		LCD_VAR_TEMP , 0
	ENDIF
	IF CURSOR_VISIVEL_LINHA == 1
		BSF		LCD_VAR_TEMP , 1
	ELSE IF CURSOR_VISIVEL_LINHA == 0
		BCF		LCD_VAR_TEMP , 1
	ENDIF
	IF LIGA_DISPLAY == 1
		BSF		LCD_VAR_TEMP , 2
	ELSE IF LIGA_DISPLAY == 0
		BCF		LCD_VAR_TEMP , 2
	ENDIF
	IF LCD_BITS_PORTA == .4 ;4 bits
	
	ELSE IF LCD_BITS_PORTA == .8 ;8 bits
		MACRO_LCD_PORTA_COMUNICACAO_8BITS LCD_VAR_TEMP , 'C' , 'U' , .50
	ENDIF
ENDM

MACRO_LCD_DESLOCAMENTO_CURSOR_MENSAGEM MACRO DUASLINHAS , BARRAMENTO8BITS ;function set
	MOVLW		LCD_DESLOC_CURSOR_MSG
	MOVWF		LCD_VAR_TEMP	
	IF DUASLINHAS == 1
		BSF		LCD_VAR_TEMP , 2
		BSF		LCD_VAR_TEMP , 3
	ELSE IF DUASLINHAS == 0
		BCF		LCD_VAR_TEMP , 2
		BCF		LCD_VAR_TEMP , 3
	ENDIF
	IF BARRAMENTO8BITS == 1
		BSF		LCD_VAR_TEMP , 4
	ELSE IF BARRAMENTO8BITS == 0
		BCF		LCD_VAR_TEMP , 4
	ENDIF
	IF LCD_BITS_PORTA == .4 ;4 bits
	
	ELSE IF LCD_BITS_PORTA == .8 ;8 bits
		MACRO_LCD_PORTA_COMUNICACAO_8BITS LCD_VAR_TEMP , 'C' , 'U' , .50
	ENDIF
ENDM

MACRO_LCD_POSICIONA_CURSOR_16x2 MACRO LINHA , COLUNA ;set DDRAM ADRESS
	IF LINHA < .1
		EXITM
	ELSE IF LINHA > .2
		EXITM
	ELSE IF COLUNA < .1
		EXITM
	ELSE IF COLUNA > .16
		EXITM
	ENDIF
	IF LINHA == .1
		MOVWF		COLUNA
		SUBLW		.1
		ADDLW		0x80
	ELSE IF LINHA == .2
		MOVWF		COLUNA
		SUBLW		.1
		ADDLW		0xC0
	ENDIF
	IF LCD_BITS_PORTA == .4 ;4 bits
	
	ELSE IF LCD_BITS_PORTA == .8 ;8 bits
		MACRO_LCD_PORTA_COMUNICACAO_8BITS W , 'C' , 'U' , .50
	ENDIF
ENDM

